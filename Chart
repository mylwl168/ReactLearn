import { Chart, Plugin } from "chart.js";

const BlackBoxPlugin: Plugin = {
  id: "blackBox",
  beforeDraw: (chart: Chart) => {
    const ctx = chart.ctx;
    const xAxis = chart.scales.x;
    if (!xAxis) return; // ğŸ¯ Xè»¸ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ã‚’çµ‚äº†

    const padding = 12; // ğŸ¯ ä½™ç™½ï¼ˆãƒœãƒƒã‚¯ã‚¹ã®é«˜ã•ã‚’èª¿æ•´ï¼‰
    let maxLabelHeight = 0;

    // ğŸ¯ ã™ã¹ã¦ã®ãƒ©ãƒ™ãƒ«ã®æœ€å¤§é«˜ã•ã‚’è¨ˆç®—
    xAxis.ticks.forEach((tick) => {
      const textMetrics = ctx.measureText(String(tick.label)); // `label` ã¯ `string | undefined` ã®ãŸã‚ã€æ˜ç¤ºçš„ã« `string` ã¸å¤‰æ›
      const textHeight = Math.abs(textMetrics.actualBoundingBoxAscent) + Math.abs(textMetrics.actualBoundingBoxDescent);
      maxLabelHeight = Math.max(maxLabelHeight, textHeight);
    });

    const boxHeight = maxLabelHeight + padding; // ğŸ¯ ãƒœãƒƒã‚¯ã‚¹ã®é«˜ã•ã‚’å‹•çš„ã«è¨­å®š
    const lineWidth = xAxis.options.grid?.lineWidth || 1; // ğŸ¯ Xè»¸ã®ç·šå¹…ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1ï¼‰

    const left = xAxis.left;
    const right = xAxis.right;
    const top = xAxis.top + lineWidth / 2; // ğŸ¯ Xè»¸ã¨ãƒœãƒƒã‚¯ã‚¹ã®å¢ƒç•Œã‚’æƒãˆã‚‹
    const bottom = top + boxHeight;

    // ğŸ¯ ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
    ctx.strokeStyle = "black";
    ctx.lineWidth = lineWidth;

    // ğŸ¯ é»’ã„ãƒœãƒƒã‚¯ã‚¹ã®æ ç·šã‚’æç”»ï¼ˆå…¨ã¦ã®è¾ºã‚’å¯è¦–åŒ–ï¼‰
    ctx.strokeRect(left, top, right - left, boxHeight);

    // ğŸ¯ å„ãƒ©ãƒ™ãƒ«ã®å¹…ã‚’å‡ç­‰ã«è¨ˆç®—
    const numLabels = xAxis.ticks.length;
    if (numLabels > 1) {
      const segmentWidth = (right - left) / numLabels; // ğŸ¯ ãƒ©ãƒ™ãƒ«é–“ã®å‡ç­‰ãªå¹…ã‚’è¨ˆç®—

      // ğŸ¯ å‚ç›´æ–¹å‘ã®åŒºåˆ‡ã‚Šç·šã‚’æç”»
      for (let i = 1; i < numLabels; i++) {
        const x = left + i * segmentWidth;

        ctx.beginPath();
        ctx.moveTo(x, top);
        ctx.lineTo(x, bottom);
        ctx.stroke();
      }
    }

    // ğŸ¯ **ãƒœãƒƒã‚¯ã‚¹ã®åº•è¾ºã‚’æ˜ç¤ºçš„ã«æç”»ï¼ˆpaddingãŒå¤§ãã™ãã¦æ¶ˆãˆã‚‹ã®ã‚’é˜²ãï¼‰**
    ctx.beginPath();
    ctx.moveTo(left, bottom);
    ctx.lineTo(right, bottom);
    ctx.stroke();

    // ğŸ¯ **ãƒœãƒƒã‚¯ã‚¹ã®å³ç«¯ã®æ ç·šã‚’æ˜ç¤ºçš„ã«æç”»ï¼ˆç·šã®å¤ªã•ã‚’ç¶­æŒï¼‰**
    ctx.beginPath();
    ctx.moveTo(right, top);
    ctx.lineTo(right, bottom);
    ctx.stroke();
  },
};

export default BlackBoxPlugin;
